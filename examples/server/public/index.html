<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="color-scheme" content="light dark">
  <title>ðŸ¦™ llama.cpp - chat</title>

  <!-- TODO: embed dependencies into cpp -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div id="app">
    <div class="flex flex-col w-screen h-screen max-w-screen-md px-8 mx-auto">
      <!-- header -->
      <div class="flex flex-row items-center">
        <div class="grow text-2xl font-bold mt-8 mb-6">
          ðŸ¦™ llama.cpp - chat
        </div>
        <div>
          <!-- theme controller is copied from https://daisyui.com/components/theme-controller/ -->
          <div class="dropdown dropdown-end dropdown-bottom">
            <div tabindex="0" role="button" class="btn m-1">
              Theme
              <svg width="12px" height="12px" class="inline-block h-2 w-2 fill-current opacity-60" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2048 2048">
                <path d="M1799 349l242 241-1017 1017L7 590l242-241 775 775 775-775z"></path>
              </svg>
            </div>
            <ul tabindex="0" class="dropdown-content bg-base-300 rounded-box z-[1] w-52 p-2 shadow-2xl">
              <li v-for="theme in themes">
                <input
                  type="radio"
                  name="theme-dropdown"
                  class="theme-controller btn btn-sm btn-block btn-ghost justify-start"
                  :aria-label="theme"
                  :value="theme" />
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- chat messages -->
      <div id="messages-list" class="flex flex-col grow overflow-y-auto">
        <div class="mt-auto flex justify-center">
          <!-- placeholder to shift the message to the bottom -->
           {{ messages.length === 0 ? 'Send a message to start' : '' }}
        </div>
        <div v-for="msg in messages" :class="{
          'chat': true,
          'chat-start': msg.role !== 'user',
          'chat-end': msg.role === 'user',
        }">
          <div :class="{
            'chat-bubble': true,
            'chat-bubble-primary': msg.role === 'user',
          }">
            <p v-for="line in msg.content.split('\n')">{{ line }}</p>
          </div>
        </div>

        <!-- pending assistant message -->
        <div id="pending-msg" class="chat chat-start">
          <div v-if="pendingMsg" class="chat-bubble">
            <span v-if="!pendingMsg.content" class="loading loading-dots loading-md"></span>
            <p v-else v-for="line in pendingMsg.content.split('\n')">{{ line }}</p>
          </div>
        </div>
      </div>

      <!-- chat input -->
      <div class="flex flex-row items-center mt-8 mb-6">
        <textarea
          class="textarea textarea-bordered w-full"
          placeholder="Type a message..."
          v-model="inputMsg"
          @keydown.enter="sendMessage"
          v-bind:disabled="state !== 'ready'"
          id="msg-input"
        ></textarea>
        <button class="btn btn-primary ml-2" @click="sendMessage" v-bind:disabled="state !== 'ready'">Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { llama } from './completion.js';

    const BASE_URL = (new URL('.', document.baseURI).href).toString();

    createApp({
      data() {
        return {
          messages: [],
          inputMsg: '',
          state: 'ready',
          pendingMsg: null, // the on-going message from assistant
          abortController: null,
          // const
          themes: ['light', 'dark', 'retro', 'cyberpunk', 'aqua', 'valentine', 'synthwave'],
        }
      },
      mounted() {
        // scroll to the bottom when the pending message height is updated
        const pendingMsgElem = document.getElementById('pending-msg');
        const msgListElem = document.getElementById('messages-list');
        const resizeObserver = new ResizeObserver(() => {
          if (this.state === 'generating') {
            msgListElem.scrollTo({ top: msgListElem.scrollHeight });
          }
        });
        resizeObserver.observe(pendingMsgElem);
      },
      methods: {
        async sendMessage() {
          if (!this.inputMsg) return;

          this.messages = [
            ...this.messages,
            { role: 'user', content: this.inputMsg },
          ];
          this.inputMsg = '';
          this.pendingMsg = { role: 'assistant', content: null };
          this.state = 'generating';

          try {
            this.abortController = new AbortController();
            const params = {
              messages: this.messages,
              stream: true,
              cache_prompt: true,
            };
            const config = {
              controller: this.abortController,
              api_url: BASE_URL,
              endpoint: '/chat/completions',
            };
            for await (const chunk of llama(prompt, params, config)) {
              const stop = chunk.data.stop;
              const addedContent = chunk.data.choices[0].delta.content;
              const lastContent = this.pendingMsg.content || '';
              if (addedContent) {
                this.pendingMsg = { role: 'assistant', content: lastContent + addedContent };
              }
            }
            this.messages = [...this.messages, this.pendingMsg];
            this.pendingMsg = null;
            this.state = 'ready';
            setTimeout(() => {
              document.getElementById('msg-input').focus();
            }, 1);
          } catch (error) {
            console.error(error);
            alert(error);
            this.pendingMsg = null;
            this.state = 'ready';
          }
        },
      },
    }).mount('#app')
  </script>
</body>

</html>
